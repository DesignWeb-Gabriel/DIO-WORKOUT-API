# 🔄 Alembic - Comandos de Migração Atualizados

## 📋 Visão Geral

**Alembic** é a ferramenta de migração do SQLAlchemy que permite:

- 🔄 **Versionar mudanças** no banco de dados
- 📝 **Gerar migrações automáticas** baseadas nos modelos
- ⬆️ **Aplicar/reverter** mudanças no banco
- 📊 **Controlar versões** do schema

## 🚀 Comandos Funcionais

### **🐳 Opção 1: Via Docker (100% Confiável)**

```powershell
# ⬆️ Aplicar todas as migrações
docker-compose exec workout_api alembic upgrade head

# 📝 Criar nova migração
docker-compose exec workout_api alembic revision --autogenerate -m "descricao_mudanca"

# 📊 Ver status atual
docker-compose exec workout_api alembic current

# 📜 Ver histórico de migrações
docker-compose exec workout_api alembic history

# ⬇️ Reverter última migração
docker-compose exec workout_api alembic downgrade -1

# 🔍 Ver SQL que será executado (sem executar)
docker-compose exec workout_api alembic upgrade head --sql

# 📋 Ver informações detalhadas
docker-compose exec workout_api alembic show head
```

### **⚡ Opção 2: Via PowerShell Script**

```powershell
# ⬆️ Aplicar migrações
.\commands.ps1 migrate

# 📝 Criar nova migração
.\commands.ps1 create-migrations -d "descricao_mudanca"

# 📊 Status da migração
.\commands.ps1 migration-status

# 📜 Histórico de migrações
.\commands.ps1 migration-history

# ⬇️ Rollback (reverter)
.\commands.ps1 rollback
```

## 🏗️ Fluxo de Trabalho Completo

### **1. 🔧 Modificar Modelos**

Exemplo: Adicionar nova coluna na tabela atletas:

```python
# workoutapi/workout_api/atleta/models.py

class AtletaModel(BaseModel):
    __tablename__ = "atletas"

    # ... campos existentes ...

    # 🆕 Nova coluna
    telefone = Column(String(15), nullable=True)  # NOVA COLUNA
```

### **2. 📝 Gerar Migração Automática**

```powershell
# Via Docker (Recomendado)
docker-compose exec workout_api alembic revision --autogenerate -m "add_telefone_to_atletas"

# Via PowerShell
.\commands.ps1 create-migrations -d "add_telefone_to_atletas"
```

### **3. 📋 Verificar Migração Gerada**

O arquivo será criado em: `workoutapi/alembic/versions/YYYY_MM_DD_HHMM-xxxxx_add_telefone_to_atletas.py`

```python
"""add_telefone_to_atletas

Revision ID: xxxxx
Revises: yyyyy
Create Date: 2025-07-19 10:30:00.000000

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa

# revision identifiers
revision: str = 'xxxxx'
down_revision: Union[str, None] = 'yyyyy'

def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('atletas', sa.Column('telefone', sa.String(length=15), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('atletas', 'telefone')
    # ### end Alembic commands ###
```

### **4. ⬆️ Aplicar Migração**

```powershell
# Via Docker
docker-compose exec workout_api alembic upgrade head

# Via PowerShell
.\commands.ps1 migrate
```

### **5. ✅ Verificar Resultado**

```powershell
# Ver tabelas
.\commands.ps1 db-tables

# Ver estrutura da tabela atletas
.\commands.ps1 db-describe

# Ou via SQL direto
docker-compose exec workout_api_db psql -U workout -d workout -c "\d atletas"
```

## 📊 Status e Histórico

### **📋 Verificar Status Atual**

```powershell
# Via Docker
docker-compose exec workout_api alembic current

# Via PowerShell
.\commands.ps1 migration-status
```

**Saída esperada:**

```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
ff47dda53b64 (head)
```

### **📜 Ver Histórico Completo**

```powershell
# Via Docker
docker-compose exec workout_api alembic history --verbose

# Via PowerShell
.\commands.ps1 migration-history
```

**Saída esperada:**

```
Rev: ff47dda53b64 (head)
Parent: <base>
Path: /app/alembic/versions/2025_07_19_0720-ff47dda53b64_create_initial_tables.py

    create_initial_tables

    Revision ID: ff47dda53b64
    Revises:
    Create Date: 2025-07-19 07:20:45.123456
```

## 🎯 Casos de Uso Comuns

### **📝 Criar Migração Vazia (Manual)**

```powershell
# Quando você quer escrever SQL customizado
docker-compose exec workout_api alembic revision -m "custom_changes"
```

### **⬆️ Migrar para Versão Específica**

```powershell
# Migrar para uma revisão específica
docker-compose exec workout_api alembic upgrade ff47dda53b64

# Migrar para uma versão relativa
docker-compose exec workout_api alembic upgrade +2  # 2 versões à frente
```

### **⬇️ Reverter Migrações**

```powershell
# Voltar 1 migração
docker-compose exec workout_api alembic downgrade -1

# Voltar para versão específica
docker-compose exec workout_api alembic downgrade ff47dda53b64

# Voltar para o início (CUIDADO!)
docker-compose exec workout_api alembic downgrade base
```

### **🔍 Visualizar SQL sem Executar**

```powershell
# Ver SQL que será executado na próxima migração
docker-compose exec workout_api alembic upgrade head --sql

# Ver SQL do rollback
docker-compose exec workout_api alembic downgrade -1 --sql
```

## 🛠️ Comandos de Desenvolvimento

### **🧪 Testar Migrações**

```powershell
# 1. Fazer backup do banco
.\commands.ps1 backup-db

# 2. Aplicar migração
.\commands.ps1 migrate

# 3. Testar aplicação
.\commands.ps1 test-api

# 4. Se der problema, reverter
.\commands.ps1 rollback
```

### **🔧 Debug de Migrações**

```powershell
# Ver logs detalhados
docker-compose exec workout_api alembic -c alembic.ini upgrade head --verbose

# Verificar configuração
docker-compose exec workout_api alembic current

# Ver estrutura atual do banco
docker-compose exec workout_api_db psql -U workout -d workout -c "\dt"
```

## 🚨 Problemas Comuns e Soluções

### **❌ Erro: "Target database is not up to date"**

```powershell
# Causa: Banco desatualizado
# Solução:
.\commands.ps1 migrate
```

### **❌ Erro: "Can't locate revision identified by 'xxxxx'"**

```powershell
# Causa: Arquivo de migração não encontrado
# Solução: Verificar se arquivos estão na pasta versions/
docker-compose exec workout_api ls -la alembic/versions/
```

### **❌ Erro: "Table 'alembic_version' doesn't exist"**

```powershell
# Causa: Banco não foi inicializado
# Solução:
docker-compose exec workout_api alembic stamp head
```

### **❌ Erro: "FAILED: No module named 'workout_api'"**

```powershell
# Causa: Path do Python não configurado
# Solução: Rebuildar container
.\commands.ps1 rebuild
```

## 📋 Boas Práticas

### **✅ Antes de Criar Migração:**

1. **Backup do banco**: `.\commands.ps1 backup-db`
2. **Verificar modelos**: Revisar mudanças nos arquivos `**/models.py`
3. **Testar localmente**: Em ambiente de desenvolvimento

### **✅ Ao Criar Migração:**

1. **Nome descritivo**: `add_telefone_to_atletas` em vez de `changes`
2. **Revisar SQL gerado**: Verificar se está correto
3. **Testar upgrade/downgrade**: Ambas as direções

### **✅ Depois de Aplicar:**

1. **Verificar tabelas**: `.\commands.ps1 db-tables`
2. **Testar aplicação**: `.\commands.ps1 test-api`
3. **Commit das mudanças**: Git add + commit

## 🔄 Workflow de Produção

### **🚀 Deploy de Migrações**

```powershell
# 1. Desenvolvimento
git checkout -b feature/add-telefone
# Modificar modelos
.\commands.ps1 create-migrations -d "add_telefone_to_atletas"
.\commands.ps1 migrate
# Testar

# 2. Commit
git add .
git commit -m "feat: add telefone field to atletas"
git push

# 3. Deploy (em produção)
docker-compose exec workout_api alembic upgrade head
```

## 📚 Comandos de Referência Rápida

```powershell
# === BÁSICOS ===
docker-compose exec workout_api alembic upgrade head              # ⬆️ Aplicar migrações
docker-compose exec workout_api alembic revision --autogenerate  # 📝 Criar migração
docker-compose exec workout_api alembic current                  # 📊 Status atual
docker-compose exec workout_api alembic history                  # 📜 Histórico

# === AVANÇADOS ===
docker-compose exec workout_api alembic downgrade -1             # ⬇️ Rollback
docker-compose exec workout_api alembic upgrade head --sql       # 🔍 Ver SQL
docker-compose exec workout_api alembic show head               # 📋 Detalhes

# === POWERSHELL ===
.\commands.ps1 migrate                                          # ⬆️ Aplicar
.\commands.ps1 create-migrations -d "descricao"                # 📝 Criar
.\commands.ps1 migration-status                                # 📊 Status
.\commands.ps1 rollback                                        # ⬇️ Reverter
```

---

**🏆 Com esses comandos, você tem controle total das migrações do banco de dados!**
