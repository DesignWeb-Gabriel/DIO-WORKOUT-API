# ğŸ”„ Alembic - Comandos de MigraÃ§Ã£o Atualizados

## ğŸ“‹ VisÃ£o Geral

**Alembic** Ã© a ferramenta de migraÃ§Ã£o do SQLAlchemy que permite:

- ğŸ”„ **Versionar mudanÃ§as** no banco de dados
- ğŸ“ **Gerar migraÃ§Ãµes automÃ¡ticas** baseadas nos modelos
- â¬†ï¸ **Aplicar/reverter** mudanÃ§as no banco
- ğŸ“Š **Controlar versÃµes** do schema

## ğŸš€ Comandos Funcionais

### **ğŸ³ OpÃ§Ã£o 1: Via Docker (100% ConfiÃ¡vel)**

```powershell
# â¬†ï¸ Aplicar todas as migraÃ§Ãµes
docker-compose exec workout_api alembic upgrade head

# ğŸ“ Criar nova migraÃ§Ã£o
docker-compose exec workout_api alembic revision --autogenerate -m "descricao_mudanca"

# ğŸ“Š Ver status atual
docker-compose exec workout_api alembic current

# ğŸ“œ Ver histÃ³rico de migraÃ§Ãµes
docker-compose exec workout_api alembic history

# â¬‡ï¸ Reverter Ãºltima migraÃ§Ã£o
docker-compose exec workout_api alembic downgrade -1

# ğŸ” Ver SQL que serÃ¡ executado (sem executar)
docker-compose exec workout_api alembic upgrade head --sql

# ğŸ“‹ Ver informaÃ§Ãµes detalhadas
docker-compose exec workout_api alembic show head
```

### **âš¡ OpÃ§Ã£o 2: Via PowerShell Script**

```powershell
# â¬†ï¸ Aplicar migraÃ§Ãµes
.\commands.ps1 migrate

# ğŸ“ Criar nova migraÃ§Ã£o
.\commands.ps1 create-migrations -d "descricao_mudanca"

# ğŸ“Š Status da migraÃ§Ã£o
.\commands.ps1 migration-status

# ğŸ“œ HistÃ³rico de migraÃ§Ãµes
.\commands.ps1 migration-history

# â¬‡ï¸ Rollback (reverter)
.\commands.ps1 rollback
```

## ğŸ—ï¸ Fluxo de Trabalho Completo

### **1. ğŸ”§ Modificar Modelos**

Exemplo: Adicionar nova coluna na tabela atletas:

```python
# workoutapi/workout_api/atleta/models.py

class AtletaModel(BaseModel):
    __tablename__ = "atletas"

    # ... campos existentes ...

    # ğŸ†• Nova coluna
    telefone = Column(String(15), nullable=True)  # NOVA COLUNA
```

### **2. ğŸ“ Gerar MigraÃ§Ã£o AutomÃ¡tica**

```powershell
# Via Docker (Recomendado)
docker-compose exec workout_api alembic revision --autogenerate -m "add_telefone_to_atletas"

# Via PowerShell
.\commands.ps1 create-migrations -d "add_telefone_to_atletas"
```

### **3. ğŸ“‹ Verificar MigraÃ§Ã£o Gerada**

O arquivo serÃ¡ criado em: `workoutapi/alembic/versions/YYYY_MM_DD_HHMM-xxxxx_add_telefone_to_atletas.py`

```python
"""add_telefone_to_atletas

Revision ID: xxxxx
Revises: yyyyy
Create Date: 2025-07-19 10:30:00.000000

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa

# revision identifiers
revision: str = 'xxxxx'
down_revision: Union[str, None] = 'yyyyy'

def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('atletas', sa.Column('telefone', sa.String(length=15), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('atletas', 'telefone')
    # ### end Alembic commands ###
```

### **4. â¬†ï¸ Aplicar MigraÃ§Ã£o**

```powershell
# Via Docker
docker-compose exec workout_api alembic upgrade head

# Via PowerShell
.\commands.ps1 migrate
```

### **5. âœ… Verificar Resultado**

```powershell
# Ver tabelas
.\commands.ps1 db-tables

# Ver estrutura da tabela atletas
.\commands.ps1 db-describe

# Ou via SQL direto
docker-compose exec workout_api_db psql -U workout -d workout -c "\d atletas"
```

## ğŸ“Š Status e HistÃ³rico

### **ğŸ“‹ Verificar Status Atual**

```powershell
# Via Docker
docker-compose exec workout_api alembic current

# Via PowerShell
.\commands.ps1 migration-status
```

**SaÃ­da esperada:**

```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
ff47dda53b64 (head)
```

### **ğŸ“œ Ver HistÃ³rico Completo**

```powershell
# Via Docker
docker-compose exec workout_api alembic history --verbose

# Via PowerShell
.\commands.ps1 migration-history
```

**SaÃ­da esperada:**

```
Rev: ff47dda53b64 (head)
Parent: <base>
Path: /app/alembic/versions/2025_07_19_0720-ff47dda53b64_create_initial_tables.py

    create_initial_tables

    Revision ID: ff47dda53b64
    Revises:
    Create Date: 2025-07-19 07:20:45.123456
```

## ğŸ¯ Casos de Uso Comuns

### **ğŸ“ Criar MigraÃ§Ã£o Vazia (Manual)**

```powershell
# Quando vocÃª quer escrever SQL customizado
docker-compose exec workout_api alembic revision -m "custom_changes"
```

### **â¬†ï¸ Migrar para VersÃ£o EspecÃ­fica**

```powershell
# Migrar para uma revisÃ£o especÃ­fica
docker-compose exec workout_api alembic upgrade ff47dda53b64

# Migrar para uma versÃ£o relativa
docker-compose exec workout_api alembic upgrade +2  # 2 versÃµes Ã  frente
```

### **â¬‡ï¸ Reverter MigraÃ§Ãµes**

```powershell
# Voltar 1 migraÃ§Ã£o
docker-compose exec workout_api alembic downgrade -1

# Voltar para versÃ£o especÃ­fica
docker-compose exec workout_api alembic downgrade ff47dda53b64

# Voltar para o inÃ­cio (CUIDADO!)
docker-compose exec workout_api alembic downgrade base
```

### **ğŸ” Visualizar SQL sem Executar**

```powershell
# Ver SQL que serÃ¡ executado na prÃ³xima migraÃ§Ã£o
docker-compose exec workout_api alembic upgrade head --sql

# Ver SQL do rollback
docker-compose exec workout_api alembic downgrade -1 --sql
```

## ğŸ› ï¸ Comandos de Desenvolvimento

### **ğŸ§ª Testar MigraÃ§Ãµes**

```powershell
# 1. Fazer backup do banco
.\commands.ps1 backup-db

# 2. Aplicar migraÃ§Ã£o
.\commands.ps1 migrate

# 3. Testar aplicaÃ§Ã£o
.\commands.ps1 test-api

# 4. Se der problema, reverter
.\commands.ps1 rollback
```

### **ğŸ”§ Debug de MigraÃ§Ãµes**

```powershell
# Ver logs detalhados
docker-compose exec workout_api alembic -c alembic.ini upgrade head --verbose

# Verificar configuraÃ§Ã£o
docker-compose exec workout_api alembic current

# Ver estrutura atual do banco
docker-compose exec workout_api_db psql -U workout -d workout -c "\dt"
```

## ğŸš¨ Problemas Comuns e SoluÃ§Ãµes

### **âŒ Erro: "Target database is not up to date"**

```powershell
# Causa: Banco desatualizado
# SoluÃ§Ã£o:
.\commands.ps1 migrate
```

### **âŒ Erro: "Can't locate revision identified by 'xxxxx'"**

```powershell
# Causa: Arquivo de migraÃ§Ã£o nÃ£o encontrado
# SoluÃ§Ã£o: Verificar se arquivos estÃ£o na pasta versions/
docker-compose exec workout_api ls -la alembic/versions/
```

### **âŒ Erro: "Table 'alembic_version' doesn't exist"**

```powershell
# Causa: Banco nÃ£o foi inicializado
# SoluÃ§Ã£o:
docker-compose exec workout_api alembic stamp head
```

### **âŒ Erro: "FAILED: No module named 'workout_api'"**

```powershell
# Causa: Path do Python nÃ£o configurado
# SoluÃ§Ã£o: Rebuildar container
.\commands.ps1 rebuild
```

## ğŸ“‹ Boas PrÃ¡ticas

### **âœ… Antes de Criar MigraÃ§Ã£o:**

1. **Backup do banco**: `.\commands.ps1 backup-db`
2. **Verificar modelos**: Revisar mudanÃ§as nos arquivos `**/models.py`
3. **Testar localmente**: Em ambiente de desenvolvimento

### **âœ… Ao Criar MigraÃ§Ã£o:**

1. **Nome descritivo**: `add_telefone_to_atletas` em vez de `changes`
2. **Revisar SQL gerado**: Verificar se estÃ¡ correto
3. **Testar upgrade/downgrade**: Ambas as direÃ§Ãµes

### **âœ… Depois de Aplicar:**

1. **Verificar tabelas**: `.\commands.ps1 db-tables`
2. **Testar aplicaÃ§Ã£o**: `.\commands.ps1 test-api`
3. **Commit das mudanÃ§as**: Git add + commit

## ğŸ”„ Workflow de ProduÃ§Ã£o

### **ğŸš€ Deploy de MigraÃ§Ãµes**

```powershell
# 1. Desenvolvimento
git checkout -b feature/add-telefone
# Modificar modelos
.\commands.ps1 create-migrations -d "add_telefone_to_atletas"
.\commands.ps1 migrate
# Testar

# 2. Commit
git add .
git commit -m "feat: add telefone field to atletas"
git push

# 3. Deploy (em produÃ§Ã£o)
docker-compose exec workout_api alembic upgrade head
```

## ğŸ“š Comandos de ReferÃªncia RÃ¡pida

```powershell
# === BÃSICOS ===
docker-compose exec workout_api alembic upgrade head              # â¬†ï¸ Aplicar migraÃ§Ãµes
docker-compose exec workout_api alembic revision --autogenerate  # ğŸ“ Criar migraÃ§Ã£o
docker-compose exec workout_api alembic current                  # ğŸ“Š Status atual
docker-compose exec workout_api alembic history                  # ğŸ“œ HistÃ³rico

# === AVANÃ‡ADOS ===
docker-compose exec workout_api alembic downgrade -1             # â¬‡ï¸ Rollback
docker-compose exec workout_api alembic upgrade head --sql       # ğŸ” Ver SQL
docker-compose exec workout_api alembic show head               # ğŸ“‹ Detalhes

# === POWERSHELL ===
.\commands.ps1 migrate                                          # â¬†ï¸ Aplicar
.\commands.ps1 create-migrations -d "descricao"                # ğŸ“ Criar
.\commands.ps1 migration-status                                # ğŸ“Š Status
.\commands.ps1 rollback                                        # â¬‡ï¸ Reverter
```

---

**ğŸ† Com esses comandos, vocÃª tem controle total das migraÃ§Ãµes do banco de dados!**
